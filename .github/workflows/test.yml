name: Test

on:
  push:
    branches:
      - 'release/**'
      - main

env:
  REGISTRY_BASE: base13114.azurecr.io
  REGISTRY_FROM: regdev13114.azurecr.io
  REGISTRY_TO: regprod13114.azurecr.io
  IMAGE: 'nico13114'
  APP_NAME_DEV: 'webdev13114'
  APP_NAME_PRD: 'webprod13114'

jobs:
  publish-uat:
    runs-on: 'ubuntu-latest'
    environment: 'dev'
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v3
        with:
          images: regdev13114.azurecr.io/nico13114
          tags: |
            # minimal (short sha)
            type=sha
            # full length sha
            type=sha,format=long
      - name: 'display meta'
        run: |
          echo $BUILDTIME
          echo $VERSION
          echo $REVISION
        env:
          BUILDTIME: ${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
          VERSION: ${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.version'] }}
          REVISION: ${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.revision'] }}
      - name: 'azure registry login'
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.REGISTRY_BASE }}
          username: ${{ secrets.ACR_SECRET_ID }}
          password: ${{ secrets.ACR_SECRET_PWD }}
      - name: 'Build the image'
        id: build
        run: |
          echo $BUILDTIME
          echo $VERSION
          echo $REVISION
          echo docker build -t ${{ env.REGISTRY_FROM }}/${{ env.IMAGE }}:$TAG
          docker build -t ${{ env.REGISTRY_FROM }}/${{ env.IMAGE }}:$TAG .
        env:
          TAG: ${{ steps.branch_name.outputs.VERSION }}-${{ github.run_id }}
          BUILDTIME: ${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
          VERSION: ${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.version'] }}
          REVISION: ${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.revision'] }}

